<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>MyVMK Snowball Dashboard</title>
    <link rel="icon" type="image/x-icon" href="./gold-logo.ico" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
    <style>
      :root {
        --penguin-color: #3b82f6;
        --reindeer-color: #ef4444;
        --bg: #fafafa;
        --card-bg: #fff;
        --border: #e5e7eb;
        --text: #111827;
        --text-muted: #6b7280;
        --hover-bg: #f9fafb;
        --input-bg: #fff;
      }

      [data-theme="dark"] {
        --bg: #111827;
        --card-bg: #1f2937;
        --border: #374151;
        --text: #f9fafb;
        --text-muted: #9ca3af;
        --hover-bg: #374151;
        --input-bg: #374151;
      }

      * { box-sizing: border-box; }

      body {
        font-family: system-ui, -apple-system, sans-serif;
        margin: 0;
        padding: 20px;
        background: var(--bg);
        color: var(--text);
        transition: background-color 0.2s, color 0.2s;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        margin-bottom: 20px;
      }

      .header-left {
        flex: 1;
      }

      .logo-center {
        flex: 0 0 auto;
      }

      .logo-center .logo {
        height: 150px;
        width: auto;
      }

      .header-left h1 {
        margin: 0 0 4px 0;
        font-size: 1.75rem;
      }

      .header-left small {
        color: var(--text-muted);
        font-size: 0.875rem;
      }

      .team-stats {
        flex: 1;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .team-stat {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 8px 14px;
        text-align: center;
        min-width: 100px;
      }

      .team-stat.penguin { border-left: 4px solid var(--penguin-color); }
      .team-stat.reindeer { border-left: 4px solid var(--reindeer-color); }

      .team-stat .label { font-size: 0.75rem; color: var(--text-muted); }
      .team-stat .value { font-size: 1.25rem; font-weight: 600; }
      .team-stat .team-logo { width: 28px; height: 28px; margin-bottom: 4px; }

      .search-bar {
        margin-bottom: 16px;
      }

      .search-bar input {
        padding: 10px 14px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 0.9rem;
        width: 320px;
        max-width: 100%;
        background: var(--input-bg);
        color: var(--text);
      }

      .search-bar input:focus {
        outline: none;
        border-color: var(--penguin-color);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 16px;
      }

      @media (max-width: 900px) {
        .row { grid-template-columns: 1fr; }
      }

      .card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
      }

      .card h3 {
        margin: 0 0 12px 0;
        font-size: 1rem;
        font-weight: 600;
      }

      .toolbar {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }

      .toolbar input {
        padding: 6px 10px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 0.8rem;
        flex: 1;
        min-width: 120px;
        background: var(--input-bg);
        color: var(--text);
      }

      .toolbar input:focus {
        outline: none;
        border-color: var(--penguin-color);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .toolbar select {
        padding: 6px 10px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 0.8rem;
        background: var(--input-bg);
        color: var(--text);
        cursor: pointer;
      }

      .toolbar select:focus {
        outline: none;
        border-color: var(--penguin-color);
      }

      .stats-panel {
        background: var(--hover-bg);
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 12px;
        display: none;
      }

      .stats-panel.visible { display: block; }

      .stats-panel .user-name {
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 8px;
      }

      .stats-panel .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 8px;
      }

      .stats-panel .stat-item {
        text-align: center;
      }

      .stats-panel .stat-label {
        font-size: 0.7rem;
        color: var(--text-muted);
        text-transform: uppercase;
      }

      .stats-panel .stat-value {
        font-size: 1rem;
        font-weight: 600;
      }

      .chip-btn {
        border: 1px solid var(--border);
        background: var(--card-bg);
        color: var(--text);
        border-radius: 8px;
        padding: 4px 10px;
        font-size: 0.8rem;
        cursor: pointer;
      }

      .chip-btn.active {
        border-color: var(--penguin-color);
        color: var(--penguin-color);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
      }

      .scroll {
        max-height: 480px;
        overflow: auto;
        border: 1px solid var(--border);
        border-radius: 8px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem;
      }

      th, td {
        border-bottom: 1px solid var(--border);
        padding: 8px 10px;
        text-align: left;
      }

      th {
        cursor: pointer;
        user-select: none;
        position: sticky;
        top: 0;
        background: var(--card-bg);
        font-weight: 600;
        white-space: nowrap;
      }

      th:hover { background: var(--hover-bg); }

      tr:hover { background: var(--hover-bg); }
      tr.highlight { background: #fef3c7 !important; }
      [data-theme="dark"] tr.highlight { background: #78350f !important; }

      .pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 500;
      }

      .pill.penguin { background: #dbeafe; color: #1e40af; }
      .pill.reindeer { background: #fee2e2; color: #991b1b; }

      .chart-container {
        position: relative;
        height: 350px;
      }

      .legend-note {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 8px;
      }

      #topLists {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }

      #topLists table {
        font-size: 0.8rem;
      }

      #topLists th, #topLists td {
        padding: 4px 8px;
      }

      /* Collapsible table styles */
      .collapsible-table .parent-row {
        cursor: pointer;
        background: var(--card-bg);
      }
      .collapsible-table .parent-row:hover {
        background: var(--hover-bg);
      }
      .collapsible-table .parent-row td:first-child::before {
        content: "â–¶ ";
        font-size: 0.7rem;
        color: var(--text-muted);
      }
      .collapsible-table .parent-row.expanded td:first-child::before {
        content: "â–¼ ";
      }
      .collapsible-table .child-row {
        display: none;
        background: var(--hover-bg);
      }
      .collapsible-table .child-row.visible {
        display: table-row;
      }
      .collapsible-table .child-row td {
        padding-left: 28px;
        font-size: 0.8rem;
        color: var(--text-muted);
      }
      .collapsible-table .child-row td:first-child {
        border-left: 2px solid var(--border);
      }
      .collapsible-table .total-row {
        font-weight: 600;
        background: var(--hover-bg);
      }

      /* Dark mode toggle */
      .theme-toggle {
        background: none;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 6px 12px;
        cursor: pointer;
        font-size: 1rem;
        color: var(--text);
      }
      .theme-toggle:hover {
        background: var(--hover-bg);
      }

      /* Date inputs */
      .toolbar input[type="date"] {
        padding: 5px 8px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 0.8rem;
        background: var(--input-bg);
        color: var(--text);
      }

      /* Heatmap styles */
      .heatmap-grid {
        display: inline-grid;
        gap: 2px;
        font-size: 0.7rem;
      }
      .heatmap-cell {
        width: 20px;
        height: 20px;
        border-radius: 3px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .heatmap-label {
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 500;
        color: var(--text-muted);
      }

      /* H2H styles */
      .h2h-user {
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 8px;
      }
      .h2h-stat {
        font-size: 0.85rem;
        color: var(--text-muted);
      }
      .h2h-value {
        font-size: 1.5rem;
        font-weight: 700;
      }
      .h2h-winner {
        color: #16a34a;
      }
      .h2h-vs {
        font-size: 1.5rem;
        font-weight: 300;
        color: var(--text-muted);
        align-self: center;
      }

      /* Combo box / autocomplete styles */
      .combo-box {
        position: relative;
        display: inline-block;
      }

      .combo-box input {
        width: 100%;
      }

      .combo-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 200px;
        overflow-y: auto;
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-top: none;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        display: none;
      }

      .combo-dropdown.visible {
        display: block;
      }

      .combo-option {
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .combo-option:hover,
      .combo-option.highlighted {
        background: var(--hover-bg);
      }

      .combo-option .pill {
        font-size: 0.7rem;
      }

      .combo-no-results {
        padding: 8px 12px;
        color: var(--text-muted);
        font-style: italic;
      }

      .search-bar .combo-box {
        width: 320px;
        max-width: 100%;
      }

      .toolbar .combo-box {
        flex: 1;
        min-width: 120px;
      }

      /* Data mode toggle */
      .data-toggle {
        display: flex;
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
        font-size: 0.8rem;
      }

      .data-toggle-btn {
        padding: 6px 12px;
        border: none;
        background: var(--card-bg);
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.8rem;
      }

      .data-toggle-btn:not(:last-child) {
        border-right: 1px solid var(--border);
      }

      .data-toggle-btn:hover {
        background: var(--hover-bg);
      }

      .data-toggle-btn.active {
        background: var(--penguin-color);
        color: white;
      }

      .data-mode-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .data-mode-label {
        font-size: 0.75rem;
        color: var(--text-muted);
      }

      /* Section link button */
      .section-header {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .section-link-btn {
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 2px 6px;
        font-size: 0.85rem;
        border-radius: 4px;
        transition: background 0.2s, color 0.2s;
      }

      .section-link-btn:hover {
        background: var(--hover-bg);
        color: var(--text);
      }

      .section-link-btn.copied {
        color: #16a34a;
      }

      /* Scroll margin for anchor links */
      [id] {
        scroll-margin-top: 20px;
      }

      /* Refresh button spin animation */
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      #refreshIcon {
        display: inline-block;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="header-left">
        <h1>MyVMK Snowball Fight Dashboard</h1>
        <small id="meta">Loading...</small>
      </div>
      <div class="logo-center">
        <img src="./snowy-logo.png" alt="Snowball Fight" class="logo" />
      </div>
      <div class="team-stats" id="teamStats"></div>
      <div class="data-mode-indicator">
        <span class="data-mode-label">Data:</span>
        <div class="data-toggle">
          <button class="data-toggle-btn active" id="dataModeLive" title="View live data">Live</button>
          <button class="data-toggle-btn" id="dataModePreReset" title="View pre-reset historical data">Pre-Reset</button>
        </div>
      </div>
      <button class="chip-btn" id="refreshDataBtn" title="Refresh data from API" style="display:flex;align-items:center;gap:4px;">
        <span id="refreshIcon">ðŸ”„</span> Refresh
      </button>
      <button class="theme-toggle" id="themeToggle" title="Toggle dark mode">ðŸŒ™</button>
    </div>

    <div class="search-bar">
      <div class="combo-box">
        <input id="userSearch" placeholder="Search username (highlights on chart)..." autocomplete="off" />
        <div class="combo-dropdown" id="userSearchDropdown"></div>
      </div>
      <span style="margin-left:8px;font-size:0.8rem;color:var(--text-muted);">Tip: search multiple users with commas. Entering just two will populate the head-to-head view.</span>
    </div>

    <div class="stats-panel" id="statsPanel">
      <div class="user-name" id="statsPanelUser"></div>
      <div class="stats-grid" id="statsPanelGrid"></div>
    </div>

    <div class="row">
      <div class="card" style="grid-column: span 2;" id="head-to-head">
        <h3 class="section-header">Head-to-Head Lookup <button class="section-link-btn" onclick="copySectionLink('head-to-head', this)" title="Copy link to section">ðŸ”—</button></h3>
        <div class="toolbar">
          <div class="combo-box">
            <input id="h2hUser1" placeholder="User 1..." autocomplete="off" />
            <div class="combo-dropdown" id="h2hUser1Dropdown"></div>
          </div>
          <span style="color:var(--text-muted);">vs</span>
          <div class="combo-box">
            <input id="h2hUser2" placeholder="User 2..." autocomplete="off" />
            <div class="combo-dropdown" id="h2hUser2Dropdown"></div>
          </div>
          <button class="chip-btn" id="h2hCompare">Compare</button>
        </div>
        <div id="h2hResult" style="display:none;margin-top:12px;">
          <div id="h2hStats" style="display:grid;grid-template-columns:1fr auto 1fr;gap:16px;text-align:center;"></div>
        </div>
        <p class="legend-note">Enter two usernames to see their head-to-head battle history.</p>
      </div>
    </div>

    <div class="row">
      <div class="card" id="scatter-chart">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
          <h3 style="margin:0;" class="section-header">Attacks vs Hits Taken <button class="section-link-btn" onclick="copySectionLink('scatter-chart', this)" title="Copy link to section">ðŸ”—</button></h3>
          <button class="chip-btn" id="resetScatterZoom">Reset View</button>
        </div>
        <div class="chart-container">
          <canvas id="scatter"></canvas>
        </div>
        <p class="legend-note">
          Scroll to zoom. Drag to pan. Double-click to zoom in; Shift+double-click to zoom out.
        </p>
      </div>
      <div class="card" id="users">
        <h3 class="section-header">Users <span id="userCount" style="font-weight:normal;color:var(--text-muted);font-size:0.875rem;"></span> <button class="section-link-btn" onclick="copySectionLink('users', this)" title="Copy link to section">ðŸ”—</button></h3>
        <div class="toolbar">
          <input id="filterExpr" placeholder="Filter examples: attacks > 100, ratio >= 2" />
          <select id="teamFilter">
            <option value="All">All Teams</option>
            <option value="Penguin">Penguin</option>
            <option value="Reindeer">Reindeer</option>
          </select>
          <select id="sortSelect">
            <option value="attacks-desc">Attacks (High-Low)</option>
            <option value="attacks-asc">Attacks (Low-High)</option>
            <option value="hitsTaken-desc">Hits Taken (High-Low)</option>
            <option value="hitsTaken-asc">Hits Taken (Low-High)</option>
            <option value="ratio-desc">Ratio (High-Low)</option>
            <option value="ratio-asc">Ratio (Low-High)</option>
            <option value="user-asc">Username (A-Z)</option>
            <option value="user-desc">Username (Z-A)</option>
          </select>
        </div>
        <div class="scroll">
          <table id="usersTable"></table>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="card" id="rooms">
        <h3 class="section-header">Hits by Room (with Avg User Ratio) <button class="section-link-btn" onclick="copySectionLink('rooms', this)" title="Copy link to section">ðŸ”—</button></h3>
        <div class="chart-container">
          <canvas id="roomsChart"></canvas>
        </div>
        <p class="legend-note">Bars = total hits in room. Line = average user attack/defense ratio in that room.</p>
      </div>
      <div class="card" id="top-performers">
        <h3 class="section-header">Top Performers <button class="section-link-btn" onclick="copySectionLink('top-performers', this)" title="Copy link to section">ðŸ”—</button></h3>
        <div id="topLists"></div>
      </div>
    </div>

    <div class="row">
      <div class="card" id="daily-attacks">
        <h3 class="section-header">Daily Attacks (Last 7 Days) <button class="section-link-btn" onclick="copySectionLink('daily-attacks', this)" title="Copy link to section">ðŸ”—</button></h3>
        <div class="chart-container">
          <canvas id="dailyChart"></canvas>
        </div>
        <p class="legend-note">Hover over bars to see top 10 attackers for each team on that day.</p>
      </div>
      <div class="card" id="heatmap-section">
        <h3 class="section-header">Activity Heatmap <button class="section-link-btn" onclick="copySectionLink('heatmap-section', this)" title="Copy link to section">ðŸ”—</button></h3>
        <div id="heatmapContainer" style="overflow-x:auto;">
          <div id="heatmap"></div>
        </div>
        <p class="legend-note">Hours (ET) vs days. Darker = more attacks.</p>
      </div>
    </div>

    <div class="row">
      <div class="card" style="grid-column: span 2;" id="victim-breakdown">
        <h3 class="section-header">User Victim Breakdown <button class="section-link-btn" onclick="copySectionLink('victim-breakdown', this)" title="Copy link to section">ðŸ”—</button></h3>
        <div class="toolbar">
          <input id="victimTableSearch" placeholder="Search attacker..." />
          <select id="victimTableTeam">
            <option value="All">All Teams</option>
            <option value="Penguin">Penguin</option>
            <option value="Reindeer">Reindeer</option>
          </select>
        </div>
        <div class="scroll" style="max-height: 500px;">
          <table id="victimBreakdownTable" class="collapsible-table"></table>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="card" id="penguin-roster">
        <h3 class="section-header" style="display:flex;align-items:center;gap:8px;">
          <img src="penguin.png" alt="Penguin" style="width:24px;height:24px;">
          Penguin Roster
          <span id="penguinRosterCount" style="font-weight:normal;color:var(--text-muted);font-size:0.875rem;"></span>
          <button class="section-link-btn" onclick="copySectionLink('penguin-roster', this)" title="Copy link to section">ðŸ”—</button>
        </h3>
        <div class="toolbar">
          <input id="penguinRosterSearch" placeholder="Search Penguin members..." />
        </div>
        <div class="scroll" style="max-height:300px;">
          <table id="penguinRosterTable"></table>
        </div>
      </div>
      <div class="card" id="reindeer-roster">
        <h3 class="section-header" style="display:flex;align-items:center;gap:8px;">
          <img src="reindeer.png" alt="Reindeer" style="width:24px;height:24px;">
          Reindeer Roster
          <span id="reindeerRosterCount" style="font-weight:normal;color:var(--text-muted);font-size:0.875rem;"></span>
          <button class="section-link-btn" onclick="copySectionLink('reindeer-roster', this)" title="Copy link to section">ðŸ”—</button>
        </h3>
        <div class="toolbar">
          <input id="reindeerRosterSearch" placeholder="Search Reindeer members..." />
        </div>
        <div class="scroll" style="max-height:300px;">
          <table id="reindeerRosterTable"></table>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="card" style="grid-column: span 2;" id="all-events">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <h3 style="margin:0;" class="section-header">All Events <span id="eventsCount" style="font-weight:normal;color:var(--text-muted);font-size:0.875rem;"></span> <button class="section-link-btn" onclick="copySectionLink('all-events', this)" title="Copy link to section">ðŸ”—</button></h3>
          <button class="chip-btn" id="downloadEventsBtn">Download CSV</button>
        </div>
        <div class="toolbar" style="flex-wrap:wrap;">
          <input id="eventsSearch" placeholder="Search attacker or victim..." />
          <select id="eventsTeamFilter">
            <option value="All">All Teams</option>
            <option value="Penguin">Penguin</option>
            <option value="Reindeer">Reindeer</option>
          </select>
          <select id="eventsRoomFilter">
            <option value="All">All Rooms</option>
          </select>
          <input type="date" id="eventsDateFrom" title="From date" />
          <input type="date" id="eventsDateTo" title="To date" />
          <select id="eventsSort">
            <option value="time-desc">Newest First</option>
            <option value="time-asc">Oldest First</option>
            <option value="attacker-asc">Attacker (A-Z)</option>
            <option value="attacker-desc">Attacker (Z-A)</option>
            <option value="team-asc">Team (A-Z)</option>
            <option value="team-desc">Team (Z-A)</option>
            <option value="victim-asc">Victim (A-Z)</option>
            <option value="victim-desc">Victim (Z-A)</option>
            <option value="room-asc">Room (A-Z)</option>
            <option value="room-desc">Room (Z-A)</option>
          </select>
        </div>
        <div class="scroll" style="max-height: 500px;">
          <table id="eventsTable"></table>
        </div>
        <p class="legend-note">Click column headers to sort. Download exports all filtered results.</p>
      </div>
    </div>

    <script src="./app.js"></script>
  </body>
</html>
